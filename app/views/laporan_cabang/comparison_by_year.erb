<%= form_tag laporan_cabang_comparison_by_year_path, :method => 'get' do %>

  <p>
    <%= label_tag 'Periode' %>
    <%= text_field_tag 'periode' %>
  </p>
  <br />
  <p>
    <%= submit_tag "Submit" %>
  </p>
<% end %>
<br />

<% unless params[:periode].nil? %>
  <% cache do %>
    <table id="table_year" class="pretty">
      <p>WEEKLY SALES PERFORMANCE</p>
      <p><%= @periode.to_date.strftime('%B %Y')  %></p>
      <p>WEEK <%= @periode.to_date.cweek %></p><br />
      <p>Classic Brand</p><br />
      <thead>
        <tr>
          <th rowspan="4">Branches</th>
          <th colspan="14">Comparison</th>
        </tr>
        <tr>
          <th colspan="3">Last Week</th>
          <th colspan="3">This Week</th>
          <th colspan="3">Total bulan berjalan <br /> s/d <%= @periode.to_date.strftime('%d %B')  %></th>
          <th colspan="3">Akumulasi Total</th>
        </tr>
        <tr>
          <% (1..2).each do |loop| %>
            <th><%= 1.year.ago(@periode.to_date).year %></th>
            <th><%= @periode.to_date.year %></th>
            <th rowspan="2">%</th>
          <% end %>
          <th rowspan="2"><%= 1.year.ago(@periode.to_date).year %></th>
          <th rowspan="2"><%= @periode.to_date.year %></th>
          <th rowspan="2">%</th>
          <th rowspan="2">Jan s/d <br /> <%= 1.year.ago(@periode.to_date).strftime('%d %b %Y') %></th>
          <th rowspan="2">Jan s/d <br /> <%= @periode.to_date.strftime('%d %b %Y') %></th>
          <th rowspan="2">%</th>
        </tr>
        <tr>
          <th><%= @last_week_on_last_year.strftime('%d') %>-<%= 1.year.ago(1.weeks.ago(@periode.to_date)).to_date.strftime('%d %b') %></th>
          <th><%= @last_week_on_current_year.strftime('%d') %>-<%= 1.weeks.ago(@periode.to_date).to_date.strftime('%d %b') %></th>
          <th><%= @this_week_on_last_year.strftime('%d') %> - <%= 1.year.ago(@periode.to_date).strftime('%d %b')  %></th>
          <th><%= @this_week_on_current_year.strftime('%d') %> - <%= @periode.to_date.strftime('%d %b')  %></th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th scope="row">Total</th>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>2.7</td>
          <td>0.1</td>
          <td>2.7</td>
          <td>0.1</td>
          <td>2.7</td>
          <td>0.1</td>
        </tr>
      </tfoot>
      <tbody>
        <% @cabang_get_id.each do |cabang| %>
          <tr>
            <% laporan_cabang_by_cabang =  cabang.laporan_cabang %>
            <th scope="row"><%= cabang.Cabang %></th>
            <td><%= weekly_last_week_on_last_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_last_year(@periode.to_date, 'Classic') %></td>
            <td><%= weekly_last_week_on_current_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_current_year(@periode.to_date, 'Classic') %></td>
            <td><%= weekly_last_week_on_last_year == 0 &&  weekly_last_week_on_current_year ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(weekly_last_week_on_last_year, weekly_last_week_on_current_year), :precision => 0) %></td>

            <td><%= weekly_this_week_on_last_year = laporan_cabang_by_cabang.weekly_sum_week_on_last_year(@periode.to_date, 'Classic') %></td>
            <td><%= weekly_this_week_on_current_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_last_year(@periode.to_date, 'Classic') %></td>
            <td><%= weekly_this_week_on_last_year == 0 &&  weekly_this_week_on_current_year ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(weekly_this_week_on_last_year, weekly_this_week_on_current_year), :precision => 0) %></td>

            <td><%= monthly_last_year =  laporan_cabang_by_cabang.monthly_sum_last_year(@periode.to_date, "Classic") %></td>
            <td><%= monthly_current_year = laporan_cabang_by_cabang.monthly_sum_current_year(@periode.to_date, "Classic") %></td>
            <td><%= monthly_last_year == 0 && monthly_current_year == 0 ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(monthly_last_year, monthly_current_year), :precision => 0) %></td>

            <td><%= yearly_last_year = laporan_cabang_by_cabang.yearly_sum_last_year(@periode.to_date, "Classic") %></td>
            <td><%= yearly_current_year = laporan_cabang_by_cabang.yearly_sum_current_year(@periode.to_date, "Classic") %></td>
            <td><%= yearly_last_year == 0 && yearly_current_year== 0 ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(yearly_last_year, yearly_current_year), :precision => 0) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <br />
    <table id="table_year_elite" class="pretty">
      <p>WEEKLY SALES PERFORMANCE</p>
      <p><%= @periode.to_date.strftime('%B %Y')  %></p>
      <p>WEEK <%= @periode.to_date.cweek %></p><br />
      <p>Elite Brand</p>  
      <thead>
        <tr>
          <th rowspan="5">Branches</th>
          <th colspan="20">Comparison</th>
        </tr>
        <tr>
          <th colspan="6">Serenity</th>
          <th colspan="6">Non Serenity</th>
          <th colspan="3" rowspan="2">Total bulan berjalan <br /> s/d <%= @periode.to_date.strftime('%d %B')  %></th>
          <th colspan="3" rowspan="2">Akumulasi Total</th>
        </tr>
        <tr>
          <% (1..2).each do |loop| %>
            <th colspan="3">Last Week</th>
            <th colspan="3">This Week</th>
          <% end %>
        </tr>
        <tr>
          <% (1..4).each do |loop| %>
            <th><%= 1.year.ago(@periode.to_date).year %></th>
            <th><%= @periode.to_date.year %></th>
            <th rowspan="2">%</th>
          <% end %>
          <th rowspan="2"><%= 1.year.ago(@periode.to_date).year %></th>
          <th rowspan="2"><%= @periode.to_date.year %></th>
          <th rowspan="2">%</th>
          <th rowspan="2">Jan s/d <br /> <%= 1.year.ago(@periode.to_date).strftime('%d %b %Y') %></th>
          <th rowspan="2">Jan s/d <br /> <%= @periode.to_date.strftime('%d %b %Y') %></th>
          <th rowspan="2">%</th>
        </tr>
        <tr>
          <% (1..2).each do |loop| %>
            <th><%= @last_week_on_last_year.strftime('%d') %>-<%= 1.year.ago(1.weeks.ago(@periode.to_date)).to_date.strftime('%d %b') %></th>
            <th><%= @last_week_on_current_year.strftime('%d') %>-<%= 1.weeks.ago(@periode.to_date).to_date.strftime('%d %b') %></th>
            <th><%= @this_week_on_last_year.strftime('%d') %> - <%= 1.year.ago(@periode.to_date).strftime('%d %b')  %></th>
            <th><%= @this_week_on_current_year.strftime('%d') %> - <%= @periode.to_date.strftime('%d %b')  %></th>
          <% end %>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th scope="row">Total</th>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
      <tbody>
        <% @cabang_get_id.each do |cabang| %>
          <tr>
            <% laporan_cabang_by_cabang =  cabang.laporan_cabang %>
            <th scope="row"><%= cabang.Cabang %></th>
            <td><%= weekly_last_week_on_last_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_last_year(@periode.to_date, 'Serenity') %></td>
            <td><%= weekly_last_week_on_current_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_current_year(@periode.to_date, 'Serenity') %></td>
            <td><%= weekly_last_week_on_last_year == 0 &&  weekly_last_week_on_current_year ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(weekly_last_week_on_last_year, weekly_last_week_on_current_year), :precision => 0) %></td>

            <td><%= weekly_this_week_on_last_year = laporan_cabang_by_cabang.weekly_sum_week_on_last_year(@periode.to_date, 'Serenity') %></td>
            <td><%= weekly_this_week_on_current_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_last_year(@periode.to_date, 'Serenity') %></td>
            <td><%= weekly_this_week_on_last_year == 0 &&  weekly_this_week_on_current_year ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(weekly_this_week_on_last_year, weekly_this_week_on_current_year), :precision => 0) %></td>

            <td><%= weekly_last_week_on_last_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_last_year(@periode.to_date, 'Non Serenity') %></td>
            <td><%= weekly_last_week_on_current_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_current_year(@periode.to_date, 'Non Serenity') %></td>
            <td><%= weekly_last_week_on_last_year == 0 &&  weekly_last_week_on_current_year ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(weekly_last_week_on_last_year, weekly_last_week_on_current_year), :precision => 0) %></td>

            <td><%= weekly_this_week_on_last_year = laporan_cabang_by_cabang.weekly_sum_week_on_last_year(@periode.to_date, 'Non Serenity') %></td>
            <td><%= weekly_this_week_on_current_year = laporan_cabang_by_cabang.weekly_sum_last_week_on_last_year(@periode.to_date, 'Non Serenity') %></td>
            <td><%= weekly_this_week_on_last_year == 0 &&  weekly_this_week_on_current_year ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(weekly_this_week_on_last_year, weekly_this_week_on_current_year), :precision => 0) %></td>

            <td><%= monthly_last_year =  laporan_cabang_by_cabang.monthly_sum_last_year(@periode.to_date, "Serenity") %></td>
            <td><%= monthly_current_year = laporan_cabang_by_cabang.monthly_sum_current_year(@periode.to_date, "Serenity") %></td>
            <td><%= monthly_last_year == 0 && monthly_current_year == 0 ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(monthly_last_year, monthly_current_year), :precision => 0) %></td>

            <td><%= yearly_last_year = laporan_cabang_by_cabang.yearly_sum_last_year(@periode.to_date, "Serenity") %></td>
            <td><%= yearly_current_year = laporan_cabang_by_cabang.yearly_sum_current_year(@periode.to_date, "Serenity") %></td>
            <td><%= yearly_last_year == 0 && yearly_current_year== 0 ? 0 : number_to_percentage(cabang.laporan_cabang.get_percentage(yearly_last_year, yearly_current_year), :precision => 0) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>

  <% end %>
<% end %>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    $('#table_year').dataTable( {
      sPaginationType: "full_numbers",
      bJQueryUI: true,
      "fnFooterCallback": function ( nRow, aaData ) {
        /*
         * Calculate the total market share for all browsers in this table (ie inc. outside
         * the pagination)
         */
        var iTotalLastYearMonth = 0;
        var iTotalCurrentYearMonth = 0;
        var iTotalLastYear = 0;
        var iTotalCurrentYear = 0;
        
        var iTotalLastWeekLastYear = 0;
        var iTotalLastWeekCurrentYear = 0;
        var iTotalThisWeekLastYear = 0;
        var iTotalThisWeekCurrentYear = 0;
        
        for ( var i=0 ; i<aaData.length ; i++ )
        {
          iTotalLastYearMonth += aaData[i][7]*1;
          iTotalCurrentYearMonth += aaData[i][8]*1;
          iTotalLastYear += aaData[i][10]*1;
          iTotalCurrentYear += aaData[i][11]*1;
          
          iTotalLastWeekLastYear += aaData[i][1]*1;
          iTotalLastWeekCurrentYear += aaData[i][2]*1;
          iTotalThisWeekLastYear += aaData[i][4]*1;
          iTotalThisWeekCurrentYear += aaData[i][5]*1;
        }
             
        /* Modify the footer row to match what we want */
        var nCells = nRow.getElementsByTagName('td');
        nCells[0].innerHTML = parseInt(iTotalLastWeekLastYear)
        nCells[1].innerHTML = parseInt(iTotalLastWeekCurrentYear)
        nCells[3].innerHTML = parseInt(iTotalThisWeekLastYear)
        nCells[4].innerHTML = parseInt(iTotalThisWeekCurrentYear)
        
        nCells[2].innerHTML = parseInt((iTotalLastWeekCurrentYear - iTotalLastWeekLastYear) / iTotalLastWeekLastYear * 100)
        nCells[5].innerHTML = parseInt((iTotalThisWeekCurrentYear - iTotalThisWeekLastYear) / iTotalThisWeekLastYear * 100)
        
        nCells[6].innerHTML = parseInt(iTotalLastYearMonth)
        nCells[7].innerHTML = parseInt(iTotalCurrentYearMonth)
        nCells[9].innerHTML = parseInt(iTotalLastYear)
        nCells[10].innerHTML = parseInt(iTotalCurrentYear)
        nCells[8].innerHTML = parseInt((iTotalCurrentYearMonth - iTotalLastYearMonth) / iTotalLastYearMonth * 100) ;
        nCells[11].innerHTML = parseInt((iTotalCurrentYear - iTotalLastYear) / iTotalLastYear * 100) ;
      },
      "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
        
        var iTotalLastYearMonth = 0;
        
        for ( var i=0 ; i< aData.length ; i++ )
        {
          iTotalLastYearMonth = aData[i][2];
        }
      }
    });
    $('#table_year_elite').dataTable({
      sPaginationType: "full_numbers",
      bJQueryUI: true,
      "fnFooterCallback": function ( nRow, aaData ) {
        /*
         * Calculate the total market share for all browsers in this table (ie inc. outside
         * the pagination)
         */
        var iTotalLastYearMonth = 0;
        var iTotalCurrentYearMonth = 0;
        var iTotalLastYear = 0;
        var iTotalCurrentYear = 0;
        
        var iTotalLastWeekLastYear = 0;
        var iTotalLastWeekCurrentYear = 0;
        var iTotalThisWeekLastYear = 0;
        var iTotalThisWeekCurrentYear = 0;
        
        var iTotalLastWeekLastYear2 = 0;
        var iTotalLastWeekCurrentYear2 = 0;
        var iTotalThisWeekLastYear2 = 0;
        var iTotalThisWeekCurrentYear2 = 0;
        
        for ( var i=0 ; i<aaData.length ; i++ )
        {
          iTotalLastYearMonth += aaData[i][13]*1;
          iTotalCurrentYearMonth += aaData[i][14]*1;
          iTotalLastYear += aaData[i][16]*1;
          iTotalCurrentYear += aaData[i][17]*1;
          
          iTotalLastWeekLastYear += aaData[i][1]*1;
          iTotalLastWeekCurrentYear += aaData[i][2]*1;
          iTotalThisWeekLastYear += aaData[i][4]*1;
          iTotalThisWeekCurrentYear += aaData[i][5]*1;
          
          iTotalLastWeekLastYear2 += aaData[i][7]*1;
          iTotalLastWeekCurrentYear2 += aaData[i][8]*1;
          iTotalThisWeekLastYear2 += aaData[i][10]*1;
          iTotalThisWeekCurrentYear2 += aaData[i][11]*1;
        }
             
        /* Modify the footer row to match what we want */
        var nCells = nRow.getElementsByTagName('td');
        nCells[0].innerHTML = parseInt(iTotalLastWeekLastYear)
        nCells[1].innerHTML = parseInt(iTotalLastWeekCurrentYear)
        nCells[3].innerHTML = parseInt(iTotalThisWeekLastYear)
        nCells[4].innerHTML = parseInt(iTotalThisWeekCurrentYear)
        
        nCells[2].innerHTML = parseInt((iTotalLastWeekCurrentYear - iTotalLastWeekLastYear) / iTotalLastWeekLastYear * 100)
        nCells[5].innerHTML = parseInt((iTotalThisWeekCurrentYear - iTotalThisWeekLastYear) / iTotalThisWeekLastYear * 100)
        
        nCells[6].innerHTML = parseInt(iTotalLastWeekLastYear2)
        nCells[7].innerHTML = parseInt(iTotalLastWeekCurrentYear2)
        nCells[9].innerHTML = parseInt(iTotalThisWeekLastYear2)
        nCells[10].innerHTML = parseInt(iTotalThisWeekCurrentYear2)
        
        nCells[8].innerHTML = parseInt((iTotalLastWeekCurrentYear2 - iTotalLastWeekLastYear2) / iTotalLastWeekLastYear2 * 100)
        nCells[11].innerHTML = parseInt((iTotalThisWeekCurrentYear2 - iTotalThisWeekLastYear2) / iTotalThisWeekLastYear2 * 100)
        
        nCells[12].innerHTML = parseInt(iTotalLastYearMonth)
        nCells[13].innerHTML = parseInt(iTotalCurrentYearMonth)
        nCells[15].innerHTML = parseInt(iTotalLastYear)
        nCells[16].innerHTML = parseInt(iTotalCurrentYear)
        nCells[14].innerHTML = parseInt((iTotalCurrentYearMonth - iTotalLastYearMonth) / iTotalLastYearMonth * 100) ;
        nCells[17].innerHTML = parseInt((iTotalCurrentYear - iTotalLastYear) / iTotalLastYear * 100) ;
      }
    });
  });
</script>