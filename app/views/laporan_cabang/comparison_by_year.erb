<%= form_tag laporan_cabang_comparison_by_year_path, :method => 'get' do %>

  <p>
    <%= label_tag 'Periode' %>
    <%= text_field_tag 'periode' %>
  </p>
  <br />
  <p>
    <%= label_tag 'Minggu ke' %>
    <%= text_field_tag 'week' %>
  </p>
  <br />
  <p>
    Periode Range<br /><br />
    <%= label_tag 'From' %>
    <%= text_field_tag 'from'  %>
    <%= label_tag 'To' %>
    <%= text_field_tag 'to' %>
  </p>
  <br /><br />
  <p>
    <%= submit_tag "Submit" %>
  </p>
<% end %>
<br />

<% unless params[:periode].nil? %>

  <table id="table_year" class="pretty">
    <thead>
      <tr>
        <th rowspan="4">Branches</th>
        <th colspan="14">Comparison</th>
      </tr>
      <tr>
        <th colspan="3">Last Week</th>
        <th colspan="3">This Week</th>
        <th colspan="3">Total bulan berjalan <br /> s/d <%= @periode.to_date.strftime('%d %B')  %></th>
        <th colspan="3">Akumulasi Total</th>
      </tr>
      <tr>
        <% (1..2).each do |loop| %>
          <th><%= 1.year.ago(@periode.to_date).year %></th>
          <th><%= @periode.to_date.year %></th>
          <th rowspan="2">%</th>
        <% end %>
        <th rowspan="2"><%= 1.year.ago(@periode.to_date).year %></th>
        <th rowspan="2"><%= @periode.to_date.year %></th>
        <th rowspan="2">%</th>
        <th rowspan="2">Jan s/d <br /> <%= 1.year.ago(@periode.to_date).strftime('%d %b %Y') %></th>
        <th rowspan="2">Jan s/d <br /> <%= @periode.to_date.strftime('%d %b %Y') %></th>
        <th rowspan="2">%</th>
      </tr>
      <tr>
        <th><%= @last_week_on_last_year.strftime('%d') %>-<%= 1.year.ago(1.weeks.ago(@periode.to_date)).to_date.strftime('%d %b') %></th>
        <th><%= @last_week_on_current_year.strftime('%d') %>-<%= 1.weeks.ago(@periode.to_date).to_date.strftime('%d %b') %></th>
        <th><%= @this_week_on_last_year.strftime('%d') %> - <%= 1.year.ago(@periode.to_date).strftime('%d %b')  %></th>
        <th><%= @this_week_on_current_year.strftime('%d') %> - <%= @periode.to_date.strftime('%d %b')  %></th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th scope="row">Total</th>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>2.7</td>
        <td>0.1</td>
        <td>2.7</td>
        <td>0.1</td>
        <td>2.7</td>
        <td>0.1</td>
      </tr>
    </tfoot>
    <tbody>
      <% @cabang_get_id.each do |cabang| %>
        <tr>
          <th scope="row"><%= cabang.Cabang %></th>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td><%= monthly_last_year =  cabang.laporan_cabang.monthly_sum_last_year(@periode.to_date) %></td>
          <td><%= monthly_current_year = cabang.laporan_cabang.monthly_sum_current_year(@periode.to_date) %></td>
          <td><%= number_to_percentage(cabang.laporan_cabang.get_percentage(monthly_last_year, monthly_current_year), :precision => 0) %></td>
          <td><%= yearly_last_year = cabang.laporan_cabang.yearly_sum_last_year(@periode.to_date) %></td>
          <td><%= yearly_current_year = cabang.laporan_cabang.yearly_sum_current_year(@periode.to_date) %></td>
          <td><%= number_to_percentage(cabang.laporan_cabang.get_percentage(yearly_last_year, yearly_current_year), :precision => 0) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

<% end %>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    $('#table_year').dataTable( {
      sPaginationType: "full_numbers",
      bJQueryUI: true,
      "fnFooterCallback": function ( nRow, aaData ) {
        /*
         * Calculate the total market share for all browsers in this table (ie inc. outside
         * the pagination)
         */
        var iTotalLastYearMonth = 0;
        var iTotalCurrentYearMonth = 0;
        var iTotalLastYear = 0;
        var iTotalCurrentYear = 0;
        
        for ( var i=0 ; i<aaData.length ; i++ )
        {
          iTotalLastYearMonth += aaData[i][7]*1;
          iTotalCurrentYearMonth += aaData[i][8]*1;
          iTotalLastYear += aaData[i][10]*1;
          iTotalCurrentYear += aaData[i][11]*1;
        }
             
        /* Modify the footer row to match what we want */
        var nCells = nRow.getElementsByTagName('td');
        nCells[6].innerHTML = parseInt(iTotalLastYearMonth)
        nCells[7].innerHTML = parseInt(iTotalCurrentYearMonth)
        nCells[9].innerHTML = parseInt(iTotalLastYear)
        nCells[10].innerHTML = parseInt(iTotalCurrentYear)
        nCells[8].innerHTML = parseInt(iTotalCurrentYearMonth - iTotalLastYearMonth) / iTotalLastYearMonth * 100 ;
        nCells[11].innerHTML = parseInt(iTotalCurrentYear - iTotalLastYear) / iTotalLastYear * 100 ;
      },
      "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
        
        var iTotalLastYearMonth = 0;
        
        for ( var i=0 ; i< aData.length ; i++ )
        {
          iTotalLastYearMonth = aData[i][2];
          console.log(iTotalLastYearMonth)
        }
      }
    });
  });
</script>